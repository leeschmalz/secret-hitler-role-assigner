Project Path: SecretHitler-SMS-Role-Assigner

Source Tree:

```txt
SecretHitler-SMS-Role-Assigner
├── README.md
├── main.py
├── roles.py
├── secret_hitler_repo.txt
└── sms.py

```

`README.md`:

```md
<p align="center">
  <img src="https://github.com/user-attachments/assets/862e86e5-15c4-45c8-a94f-599c6632ed29" alt="image">
</p>

# SecretHitler-SMS-Role-Assigner

An SMS service that can be used to privately assign roles to players via text message while playing the popular board game [Secret Hitler](https://www.secrethitler.com/). The game is typically played by passing out brown envelopes with cards inside that describe the hidden identity of each player. The players then look at their roles privately, all players close their eyes, and someone instructs the Fascist players to open their eyes or raise their hand to share the necessary pre-game information. This project solves two slight inconveniences with the standard role assignment process:
1. The eye closing and opening process gets tedious and annoying when playing many rounds.
2. The brown envelopes are made out of paper and inevitably get creased or wet in memorable ways, making it harder to keep roles a secret, and often requiring players to hide their envelope.

After initial configuration, the service will allow any player to simply text the word `assign` and all players will receive a text message with the information they should know before the game begins. For example:
- `Your role is liberal.`
- `Your role is fascist. Fascists are: (Alice is fascist) (Bob is hitler)`

The service also provides functionality for the **_Investigate Party Membership_** president power where the president can look at any player's party membership card. At this point in the game, the president will, for example, send `View Charlie`, and will receive a text message in return `Charlie's party is liberal`. Everyone else in the game will receive a text `Charlie's party membership was viewed.` to ensure players cannot secretly view each others' identities.

These two simple features allow the game to be played seamlessly without using the brown envelopes at all, and forgoing the eye closing ritual at the beginning of each round.

## Perform the following once to get started:
1. Create a free account and phone number with Twilio.
2. Put your Twilio phone number, SID, and Auth Token in a `.env` file to be accessed as follows (or just paste it into the code if you're keeping it locally):
    ```python
    phone_number = os.environ.get("TWILIO_PHONE_NUM")
    account_sid = os.environ.get("TWILIO_SID")
    auth_token = os.environ.get("TWILIO_AUTH_TOKEN")
    ```
3. Verify each player's phone number in the Twilio console by clicking "Add a new Caller ID".
4. Install dependencies:
    ```bash
    pip install twilio
    pip install python-dotenv
    ```

## Each session:
1. run python main.py. Leave it running for the whole session (or serve it elsewhere to run continuously).
2. anyone text "hello" to your twilio phone number
3. each player text "add (their name)" to your twilio phone number. All information will be passed to and from players with this phone number.
4. after all players are added, anyone text "start game"
   
## Each round:
1. anyone text `assign`. new roles will be generated and texted to everyone.
2. to enact the **_Investigate Party Membership_** president power, the president simply texts `View Bob`.
3. at any point if you need to change the player configuration, anyone can text `end game` to restart from _**Each session**_.

## Summary of Commands:
all commands are case insensitive.
- `hello`: start listening to add players. state: 'inactive' -> 'adding players'
- `add Alice`: add player called Alice.
- `start game`: done adding players. state: 'add players' -> 'active'
- `assign`: get new roles to start a new round.
- `view Eve`: view Eve's party membership. notifies other players that Eve's membership was viewed.
- `end game`: end the current sesssion to restart with new players. state: any -> 'inactive'

```

`main.py`:

```py
from sms import *
from roles import get_role_by_player_name
import time
import random

# COMMANDS
# hello: start listening to add players
# add foo: add player called foo
# start game: done assigning players
# assign: get new roles
# end game: set state to inactive

players = {}
state = 'inactive'  # one of ['inactive', 'add_players', 'active']
clear_all_messages()

while True:
    new_messages = get_new_messages()
    if new_messages:
        for latest_message in new_messages:
            content = latest_message.body.lower().strip()
            sender = latest_message.from_
            print(f'{sender} - {content}')
            if content.startswith("view "):
                _, name = content.split(" ", 1)
                role_to_send = get_role_by_player_name(name, roles)
                if role_to_send == 'hitler':
                    role_to_send = 'fascist'
                send_sms(sender, f"{name}'s party is {role_to_send}")
                random_player = random.choice(list(players.keys()))
                send_sms(players[random_player], f"{name}'s role was viewed.")

            if content == 'end game':
                players = {}
                clear_all_messages()
                state = 'inactive'
                send_sms(sender, "Game ended.")

            if state == 'inactive':
                if content == 'hello':
                    state = 'add_players'
                    send_sms(sender, "Game started. Add players.")

            if state == 'add_players':
                if content.startswith("add "):
                    _, name = content.split(" ", 1)
                    players[name] = sender
                    send_sms(sender, f"Added {name}. Text 'start game' to finish adding.")

                if content == 'start game':
                    player_count = len(list(players.keys()))
                    if player_count in [2,5,6,7,8,9,10]:
                        send_sms(sender, "Game ready. Text 'assign' to get roles.")
                        state = 'active'
                    else:
                        send_sms(sender, "Need 6-10 players to start the game.")

            if state == 'active':
                if content == 'assign':
                    roles = assign_and_notify_roles(players=players)
            print(players)
            print(state)    
    time.sleep(2)

```

`roles.py`:

```py
from random import shuffle

def generate_roles(num_players):
    roles_map = {
        2: ['liberal', 'fascist'],
        5: ['liberal']*3 + ['fascist'] + ['hitler'],
        6: ['liberal']*4 + ['fascist'] + ['hitler'],
        7: ['liberal']*4 + ['fascist']*2 + ['hitler'],
        8: ['liberal']*5 + ['fascist']*2 + ['hitler'],
        9: ['liberal']*5 + ['fascist']*3 + ['hitler'],
        10: ['liberal']*6 + ['fascist']*3 + ['hitler']
    }
    
    roles = roles_map[num_players]
    shuffle(roles)

    return roles

def get_role_by_player_name(target_player, zipped_data):
    for player, role in zipped_data:
        if player == target_player:
            return role
    return "Player not found"
```

`sms.py`:

```py
from twilio.rest import Client
import time
from roles import generate_roles

import os
from dotenv import load_dotenv
load_dotenv()

phone_number = os.environ.get("TWILIO_PHONE_NUM")
account_sid = os.environ.get("TWILIO_SID")
auth_token = os.environ.get("TWILIO_AUTH_TOKEN")
client = Client(account_sid, auth_token)

def get_new_messages():
    new_messages = []
    
    messages = client.messages.list(
        to=phone_number,
        limit=10
    )

    time.sleep(1)
    for message in reversed(messages):
        new_messages.append(message)
        message.delete()  # delete the message from Twilio after processing
    
    return new_messages

def assign_and_notify_roles(players):
    num_players = len(players.keys())

    roles = generate_roles(num_players)

    for name, role in zip(players.keys(), roles):
        # if liberal, or hitler when hitler doesn't know their team
        if role == 'liberal' or (num_players>6 and role == 'hitler'):
            send_sms(players[name], f"Your role is: {role}")

        # if liberal, or hitler when hitler knows their team
        if role == 'fascist' or (num_players<=6 and role == 'hitler'):
            message = f'Your role is: {role}. Fascists are: '
            for name2, role2 in zip(players.keys(), roles):
                if role2 != 'liberal' and name != name2:
                    message += f'({name2} is {role2})'
            send_sms(players[name], message)

    return zip(players.keys(), roles)

def send_sms(to, body):
    client.messages.create(
        body=body,
        from_=phone_number,
        to=to
    )

def clear_all_messages():
    messages = client.messages.list(
        to=phone_number,
        limit=50
    )
    for message in messages:
        message.delete()

```